# Требования и решение для прогрева данных в Tarantool Database

## Содержание
### [1. Требования к функции прогрева данных](#first)
### [2. Анализ реализации функции прогрева данных в других СУБД](#second)
### [3. Решение для Tarantool Database](#third)

<a name="first"></a>
## 1. Требования к функции прогрева данных

### 1) Автоматический прогрев при старте
Tarantool при старте должен автоматически загружать часто используемые данные из диска в RAM, учитывая статистику часто используемых данных. Прогрев не должен блокировать обработку запросов с бэкенда.

### 2) Сбор статистики по запросам
Система должна непрерывно собирать общее количество запросов на чтение для каждой таблицы.

### 3) Формирование списка данных для прогрева
Список для переноса в RAM во время прогрева формируется на основе недавних запросов к конкретным данным, наибольшего общего количества запросов к данным и вручную выбранных приоритетных.

### 4) Сохранение списка наиболее популярных данных
Периодически и перед graceful shutdown сервера система должна сохранять список данных, необходимых к прогреву.

### 5) Мониторинг
Система должна передавать метрики прогрева в Prometheus и впоследствии в Graphana для мониторинга и анализа.

### 6) Конфигурация прогрева
Система должна предоставлять возможность настраивать функцию прогрева данных (период сохранения списка, размер списка, выбор критичных/обязательных данных для прогрева и т.д.).

<a name="second"></a>
## 2. Анализ реализации функции прогрева данных в других СУБД

### 1) PostgreSQL (pg_prewarm)
Модуль pg_prewarm используется для загрузки таблиц и индексов в кэш буферов PostgreSQL или в кэш операционной системы.

Существует три режима работы: 
- prefetch (в этом режиме операционной системе выдаются асинхронные запросы предвыборки данных, если они поддерживаются, иначе происходит ошибка).
- read (в этом режиме считывается заданный диапазон блоков; считывание происходит синхронно и поддерживается во всех ОС любыми сборками; может выполняться медленнее prefetch и buffer).
- buffer (в этом режиме запрошенный диапазон блоков считывается в кеш буферов базы данных).

Ручной прогрев: SELECT pg_prewarm('table', 'buffer')

Автоматический прогрев: при добавлении pg_prewarm в shared_preload_libraries запускается фоновый воркер, который периодически сохраняет список загруженных блоков в файл autoprewarm.blocks и при запуске сервера восстанавливает их через два дополнительных фоновых процесса.

Таким образом, pg_prewarm с помощью всего одной функции дает возможность управлять прогревом данных в PostgreSQL, но прогреваемых данных не изменяется на основе статистики запросов.

### 2) SAP Hana (table preload)
Обычно HANA загружает таблицу в память только после выполнения каких-либо запросов.

Для прогрева данных SAP Hana использует table preload для явной маркировки таблиц и автоматической загрузки в RAM при старте index server. Таким образом, table preload позволяет не дожидаться выполнения какого-либо запроса к таблице, а загружает таблицу напрямую, обеспечивая мгновенный и быстрый ответ.

Существует два режима table preload:
PRELOAD ALL — полная загрузка всех колонок таблицы в память при старте.
PRELOAD (column_list) — частичная загрузка только указанных колонок.

Таблицы, маркированные через ALTER TABLE "schema"."table" PRELOAD ALL/column_list, автоматически загружаются в память при каждом рестарте index server.

Таким образом, table preload позвоялет реализовать прогрев данных через указание конкретных таблиц и колонок в SAP Hana, но список прогреваемых данных не изменяется на основе статистики запросов.

### 3) Apache Ignite
Используется решение через LoadAllWarmUpConfiguration, что представляет из себя загрузку данных с диска в RAM до присоединения ноды к кластеру. Приоритетом при загрузке всегда являются индексы, а потом остальные данные, пока есть свободное место. 

Процесс происходит автоматически без особой настройки и конфигурации. 

Таким образом, Apache Ignite использует простой способ прогрева, при котором сначала загружаются индексы, а потом все остальное, пока помещается в RAM. Просто, но нет гибкости для подбора конкретных таблиц для загрузки. 

<a name="third"></a>
## 3. Решение для Tarantool Database
Система формирует список для прогрева, комбинируя критичные, недавние и популярные данные, сохраняет его и при старте переносит данные в RAM фоновым процессом без блокировки основных запросов.

Критичные данные — вручную указанные данные.
Недавние данные — те, к которым часто обращались в последний час.
Популярные данные — те, которые стабильно используются за долгий период.

Система каждый час сохраняет текущий список данных. При graceful shutdown также выполняется финальное сохранение. Гарантируется, что статистика не потеряется при перезагрузке.

Система позволяет экспортировать метрики в Prometheus и впоследствии в Graphana.
Также дает возможность ручного конфигурирования параметров прогрева данных (период сохранения списка, размер списка, выбор критичных/обязательных данных для прогрева и т.д.)

В отличие от других СУБД такое решение вносит гибкий контроль над прогревом данных с учетом статистики и разделения на критичные/горячие/популярные данные.

